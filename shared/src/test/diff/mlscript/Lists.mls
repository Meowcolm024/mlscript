
class Nil: {}
class Cons[A]: { head: A; tail: List[A] }
type List[A] = Nil | Cons[A]
//│ Defined class Nil
//│ Defined class Cons
//│ Defined type List

def originalCons = Cons
//│ originalCons: {head: 'a, tail: List['a]} -> cons & {head: 'a, tail: List['a]}

def Nil = Nil {}
//│ Nil: nil

def Cons head tail = Cons { head; tail }
//│ Cons: 'a -> List['a] -> cons & {head: 'a, tail: List['a]}


Cons 2
//│ res: List['a] -> cons & {head: 'a | 2, tail: List['a | 2]}

Cons 2 Nil
//│ res: cons & {head: 2, tail: List[2]}

// FIXME List[1]...
Cons 1 res
//│ res: cons & {head: 1, tail: List[1]}

res.tail
//│ res: List[1]

Cons 1 (Cons 2 Nil)
//│ res: cons & {head: 1, tail: List[1]}

res.tail
//│ res: List[1]

:e // Q: why the duplicated error?
res.tail
//│ ╔══[ERROR] Type mismatch in field selection:
//│ ║  l.39: 	res.tail
//│ ║        	^^^
//│ ╟── expression of type `nil` does not have field 'tail'
//│ ║  l.4: 	type List[A] = Nil | Cons[A]
//│ ║       	               ^^^
//│ ╟── but it flows into reference with expected type `{tail: ?a}`
//│ ║  l.39: 	res.tail
//│ ╙──      	^^^
//│ res: List[1] | error

:e // Q: why the duplicated error?
res.tail.head
//│ ╔══[ERROR] Type mismatch in field selection:
//│ ║  l.52: 	res.tail.head
//│ ║        	^^^
//│ ╟── expression of type `nil` does not have field 'tail'
//│ ║  l.4: 	type List[A] = Nil | Cons[A]
//│ ║       	               ^^^
//│ ╟── but it flows into reference with expected type `{tail: ?a}`
//│ ║  l.52: 	res.tail.head
//│ ╙──      	^^^
//│ ╔══[ERROR] Type mismatch in field selection:
//│ ║  l.52: 	res.tail.head
//│ ║        	^^^
//│ ╟── expression of type `nil` does not have field 'head'
//│ ║  l.4: 	type List[A] = Nil | Cons[A]
//│ ║       	               ^^^
//│ ╟── but it flows into field selection with expected type `{head: ?a}`
//│ ║  l.52: 	res.tail.head
//│ ╙──      	^^^
//│ res: 1 | error



// More precise Cons?
def Cons head tail = originalCons { head; tail } with { head; tail }
//│ Cons: 'a -> 'b & List['c] -> ((cons & {head: 'c | 'a, tail: List['c | 'a]})\head\tail & {head: 'a}\tail) & {tail: 'b}


Cons 2
//│ res: 'a & List['b] -> ((cons & {head: 'b | 2, tail: List['b | 2]})\head\tail & {head: 2}\tail) & {tail: 'a}

Cons 2 Nil
//│ res: ((cons & {head: 2, tail: List[2]})\head\tail & {head: 2}\tail) & {tail: nil}

// FIXME
:d
res.head
//│ 0. Typing term res.head
//│  0. Typing term res
//│  0. : [α72]
//│  CONSTRAIN [[α72]] <! {head: α0}
//│    where α66 :> [2<int>], α67 :> [[α71]] <: [List[α68]], α68 :> [α66], α69 :> (cons<> & {head: α68, tail: List[α68]}), α71 :> nil<> <: [[List[α68]]], α72 :> ((α69\head-tail & {head: [α66]}\tail) & {tail: [α67]})
//│  C [[α72]] <! {head: α0}
//│   C [α72] <! {head: α0}
//│    C α72 <! {head: α0}
//│     C ((α69\head-tail & {head: [α66]}\tail) & {tail: [α67]}) <! {head: α0}
//│      A  LhsTop  %  List((α69\head-tail & {head: [α66]}\tail), {tail: [α67]})  <!  List({head: α0})  %  RhsBot
//│       A  LhsTop  %  List(α69\head-tail, {head: [α66]}\tail, {tail: [α67]})  <!  List({head: α0})  %  RhsBot
//│        A  LhsTop  %  List(α69\head-tail, {head: [α66]}\tail, {tail: [α67]})  <!  List()  %  RhsField(head,α0)
//│         !List(~({head: [α66]}\tail), ~({tail: [α67]}), ⊥)
//│         !Some(((~({head: [α66]}\tail) | ~({tail: [α67]})) | {head: α0}))
//│         C α69 <! ((~({head: [α66]}\tail)\head-tail | ~({tail: [α67]})\head-tail) | {head: α0}\head-tail)
//│          C (cons<> & {head: α68, tail: List[α68]}) <! ((~({head: [α66]}\tail)\head-tail | ~({tail: [α67]})\head-tail) | {head: α0}\head-tail)
//│           A  LhsTop  %  List((cons<> & {head: α68, tail: List[α68]}))  <!  List((~({head: [α66]}\tail)\head-tail | ~({tail: [α67]})\head-tail), {head: α0}\head-tail)  %  RhsBot
//│            A  LhsTop  %  List((cons<> & {head: α68, tail: List[α68]}))  <!  List(~({head: [α66]}\tail)\head-tail, ~({tail: [α67]})\head-tail, {head: α0}\head-tail)  %  RhsBot
//│             A  LhsTop  %  List(cons<>, {head: α68, tail: List[α68]})  <!  List(~({head: [α66]}\tail)\head-tail, ~({tail: [α67]})\head-tail, {head: α0}\head-tail)  %  RhsBot
//│              A  cons<>{}  %  List({head: α68, tail: List[α68]})  <!  List(~({head: [α66]}\tail)\head-tail, ~({tail: [α67]})\head-tail, {head: α0}\head-tail)  %  RhsBot
//│               A  cons<>{head: α68, tail: List[α68]}  %  List()  <!  List(~({head: [α66]}\tail)\head-tail, ~({tail: [α67]})\head-tail, {head: α0}\head-tail)  %  RhsBot
//│                C (((cons<> & {head: α68, tail: List[α68]}\head-tail) & ~(~({tail: [α67]})\head-tail)\head-tail) & ~({head: α0}\head-tail)\head-tail) <! ~({head: [α66]}\tail)
//│                 A  LhsTop  %  List(((cons<> & {head: α68, tail: List[α68]}\head-tail) & ~(~({tail: [α67]})\head-tail)\head-tail), ~({head: α0}\head-tail)\head-tail)  <!  List(~({head: [α66]}\tail))  %  RhsBot
//│                  A  LhsTop  %  List((cons<> & {head: α68, tail: List[α68]}\head-tail), ~(~({tail: [α67]})\head-tail)\head-tail, ~({head: α0}\head-tail)\head-tail)  <!  List(~({head: [α66]}\tail))  %  RhsBot
//│                   A  LhsTop  %  List(cons<>, {head: α68, tail: List[α68]}\head-tail, ~(~({tail: [α67]})\head-tail)\head-tail, ~({head: α0}\head-tail)\head-tail)  <!  List(~({head: [α66]}\tail))  %  RhsBot
//│                    A  LhsTop  %  List({head: [α66]}, cons<>, {head: α68, tail: List[α68]}\head-tail, ~(~({tail: [α67]})\head-tail)\head-tail, ~({head: α0}\head-tail)\head-tail)  <!  List()  %  RhsBot
//│                     A  {head: [α66]}  %  List(cons<>, {head: α68, tail: List[α68]}\head-tail, ~(~({tail: [α67]})\head-tail)\head-tail, ~({head: α0}\head-tail)\head-tail)  <!  List()  %  RhsBot
//│                      A  cons<>{head: [α66]}  %  List({}, ~(~({tail: [α67]})\head-tail)\head-tail, ~({head: α0}\head-tail)\head-tail)  <!  List()  %  RhsBot
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: ~(~({tail: [α67]})\head-tail)\head-tail (class mlscript.TyperDatatypes$Without)
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout(TyperHelpers.scala:112)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout$(TyperHelpers.scala:103)
//│ 	at: mlscript.TyperDatatypes$SimpleType.pushPosWithout(TyperDatatypes.scala:34)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$3(ConstraintSolver.scala:105)
//│ 	at: mlscript.utils.package$ListHelpers.mapHead(package.scala:121)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:148)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)

Cons 1 res
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: ~(~({tail: [α67]})\head-tail)\head-tail (class mlscript.TyperDatatypes$Without)
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout(TyperHelpers.scala:112)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout$(TyperHelpers.scala:103)
//│ 	at: mlscript.TyperDatatypes$SimpleType.pushPosWithout(TyperDatatypes.scala:34)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$3(ConstraintSolver.scala:105)
//│ 	at: mlscript.utils.package$ListHelpers.mapHead(package.scala:121)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:148)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)

Cons 1 (Cons 2 Nil)
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: ~(~({tail: [α13]})\head-tail)\head-tail (class mlscript.TyperDatatypes$Without)
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout(TyperHelpers.scala:112)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout$(TyperHelpers.scala:103)
//│ 	at: mlscript.TyperDatatypes$SimpleType.pushPosWithout(TyperDatatypes.scala:34)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$3(ConstraintSolver.scala:105)
//│ 	at: mlscript.utils.package$ListHelpers.mapHead(package.scala:121)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:148)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)

// FIXME
res.head
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: ~(~({tail: [α67]})\head-tail)\head-tail (class mlscript.TyperDatatypes$Without)
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout(TyperHelpers.scala:112)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout$(TyperHelpers.scala:103)
//│ 	at: mlscript.TyperDatatypes$SimpleType.pushPosWithout(TyperDatatypes.scala:34)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$3(ConstraintSolver.scala:105)
//│ 	at: mlscript.utils.package$ListHelpers.mapHead(package.scala:121)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:148)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)



def Cons head = originalCons { head=0; tail=Nil } with { head }
//│ Cons: 'a -> (cons & {head: 0, tail: List[0]})\head & {head: 'a}

Cons 1
//│ res: (cons & {head: 0, tail: List[0]})\head & {head: 1}

// FIXME
:d
res.head
//│ 0. Typing term res.head
//│  0. Typing term res
//│  0. : [α31]
//│  CONSTRAIN [[α31]] <! {head: α0}
//│    where α28 :> [1<int>], α29 :> (cons<> & {head: α30, tail: List[α30]}), α30 :> 0<int>, α31 :> (α29\head & {head: [α28]})
//│  C [[α31]] <! {head: α0}
//│   C [α31] <! {head: α0}
//│    C α31 <! {head: α0}
//│     C (α29\head & {head: [α28]}) <! {head: α0}
//│      A  LhsTop  %  List(α29\head, {head: [α28]})  <!  List({head: α0})  %  RhsBot
//│       A  LhsTop  %  List(α29\head, {head: [α28]})  <!  List()  %  RhsField(head,α0)
//│        !List(~({head: [α28]}), ⊥)
//│        !Some((~({head: [α28]}) | {head: α0}))
//│        C α29 <! (~({head: [α28]})\head | {head: α0}\head)
//│         C (cons<> & {head: α30, tail: List[α30]}) <! (~({head: [α28]})\head | {head: α0}\head)
//│          A  LhsTop  %  List((cons<> & {head: α30, tail: List[α30]}))  <!  List(~({head: [α28]})\head, {head: α0}\head)  %  RhsBot
//│           A  LhsTop  %  List(cons<>, {head: α30, tail: List[α30]})  <!  List(~({head: [α28]})\head, {head: α0}\head)  %  RhsBot
//│            A  cons<>{}  %  List({head: α30, tail: List[α30]})  <!  List(~({head: [α28]})\head, {head: α0}\head)  %  RhsBot
//│             A  cons<>{head: α30, tail: List[α30]}  %  List()  <!  List(~({head: [α28]})\head, {head: α0}\head)  %  RhsBot
//│              C ((cons<> & {head: α30, tail: List[α30]}\head) & ~({head: α0}\head)\head) <! ~({head: [α28]})
//│               A  LhsTop  %  List((cons<> & {head: α30, tail: List[α30]}\head), ~({head: α0}\head)\head)  <!  List(~({head: [α28]}))  %  RhsBot
//│                A  LhsTop  %  List(cons<>, {head: α30, tail: List[α30]}\head, ~({head: α0}\head)\head)  <!  List(~({head: [α28]}))  %  RhsBot
//│                 A  LhsTop  %  List({head: [α28]}, cons<>, {head: α30, tail: List[α30]}\head, ~({head: α0}\head)\head)  <!  List()  %  RhsBot
//│                  A  {head: [α28]}  %  List(cons<>, {head: α30, tail: List[α30]}\head, ~({head: α0}\head)\head)  <!  List()  %  RhsBot
//│                   A  cons<>{head: [α28]}  %  List({tail: List[α30]}, ~({head: α0}\head)\head)  <!  List()  %  RhsBot
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: ~({head: α0}\head)\head (class mlscript.TyperDatatypes$Without)
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout(TyperHelpers.scala:112)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout$(TyperHelpers.scala:103)
//│ 	at: mlscript.TyperDatatypes$SimpleType.pushPosWithout(TyperDatatypes.scala:34)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$3(ConstraintSolver.scala:105)
//│ 	at: mlscript.utils.package$ListHelpers.mapHead(package.scala:121)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:148)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)

def c = Cons 1
//│ c: (cons & {head: 0, tail: List[0]})\head & {head: 1}

c.head
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: ~({head: α13}\head)\head (class mlscript.TyperDatatypes$Without)
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout(TyperHelpers.scala:112)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout$(TyperHelpers.scala:103)
//│ 	at: mlscript.TyperDatatypes$SimpleType.pushPosWithout(TyperDatatypes.scala:34)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$3(ConstraintSolver.scala:105)
//│ 	at: mlscript.utils.package$ListHelpers.mapHead(package.scala:121)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:148)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)

