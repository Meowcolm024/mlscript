class Some[A]: { value: A }
class None: {}
//│ Defined class Some
//│ Defined class None



def flatMap3 = fun f -> fun opt -> case opt of { Some -> f opt | _ -> opt }
//│ flatMap3: ('a -> 'b) -> ((some & 'a) | ('c & ~some)) -> 'b | 'c


def arg = if true then Some{value = 42} with {payload = 23} else None {}
//│ arg: ((some & {value: 42})\payload & {payload: 23}) | none

flatMap3 (fun x -> add x.value x.payload) arg
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: ~(~(some<>)\payload)\payload (class mlscript.TyperDatatypes$Without)
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout(TyperHelpers.scala:114)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout$(TyperHelpers.scala:105)
//│ 	at: mlscript.TyperDatatypes$SimpleType.pushPosWithout(TyperDatatypes.scala:34)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$3(ConstraintSolver.scala:105)
//│ 	at: mlscript.utils.package$ListHelpers.mapHead(package.scala:121)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:153)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)


def arg = if true then Some{value = 42} else None {}
//│ arg: (some & {value: 42}) | none

flatMap3 (fun x -> x.value) arg
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: Program reached and unexpected state.
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.utils.package$.die(package.scala:134)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:182)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:107)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:156)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)


def foo = flatMap3 (fun x -> x.value)
//│ foo: ((some & {value: 'a}) | ('b & ~some)) -> 'a | 'b

foo arg
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: Program reached and unexpected state.
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.utils.package$.die(package.scala:134)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:182)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:107)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:156)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)

foo 1
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: Program reached and unexpected state.
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.utils.package$.die(package.scala:134)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:182)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:107)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:156)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)

def fn = foo None
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: Program reached and unexpected state.
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.utils.package$.die(package.scala:134)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:182)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:107)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:156)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)

// :d
fn{} // foo None {}
//│ ╔══[ERROR] identifier not found: fn
//│ ║  l.89: 	fn{} // foo None {}
//│ ╙──      	^^
//│ res: error

// :d
foo (None{})
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: Program reached and unexpected state.
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.utils.package$.die(package.scala:134)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:182)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:107)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:156)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)


fun f -> flatMap3 f arg
//│ /!!!\ Uncaught error: java.util.NoSuchElementException: head of empty String
//│ 	at: scala.collection.StringOps$.head$extension(StringOps.scala:1124)
//│ 	at: mlscript.TypeSimplifier.$anonfun$expandCompactType$7(TypeSimplifier.scala:348)
//│ 	at: scala.collection.Iterator$$anon$9.next(Iterator.scala:575)
//│ 	at: scala.collection.immutable.List.prependedAll(List.scala:153)
//│ 	at: scala.collection.IterableOnceOps.toList(IterableOnce.scala:1251)
//│ 	at: scala.collection.IterableOnceOps.toList$(IterableOnce.scala:1251)
//│ 	at: scala.collection.AbstractIterator.toList(Iterator.scala:1288)
//│ 	at: mlscript.TypeSimplifier.$anonfun$expandCompactType$3(TypeSimplifier.scala:344)
//│ 	at: scala.util.ChainingOps$.pipe$extension(ChainingOps.scala:64)
//│ 	at: mlscript.TypeSimplifier.go$3(TypeSimplifier.scala:338)




def foo = flatMap3 (fun x -> x)
//│ foo: ((some & 'a) | ('b & ~some)) -> 'a | 'b

foo 1
//│ /!!!\ Uncaught error: java.util.NoSuchElementException: head of empty String
//│ 	at: scala.collection.StringOps$.head$extension(StringOps.scala:1124)
//│ 	at: mlscript.TypeSimplifier.$anonfun$expandCompactType$7(TypeSimplifier.scala:348)
//│ 	at: scala.collection.Iterator$$anon$9.next(Iterator.scala:575)
//│ 	at: scala.collection.immutable.List.prependedAll(List.scala:153)
//│ 	at: scala.collection.IterableOnceOps.toList(IterableOnce.scala:1251)
//│ 	at: scala.collection.IterableOnceOps.toList$(IterableOnce.scala:1251)
//│ 	at: scala.collection.AbstractIterator.toList(Iterator.scala:1288)
//│ 	at: mlscript.TypeSimplifier.$anonfun$expandCompactType$3(TypeSimplifier.scala:344)
//│ 	at: scala.util.ChainingOps$.pipe$extension(ChainingOps.scala:64)
//│ 	at: mlscript.TypeSimplifier.go$3(TypeSimplifier.scala:338)




def simpler = fun f -> case None{} of { Some -> f 1 | _ -> None{} }
//│ simpler: (1 -> 'a) -> 'a | none

def simpler = fun f -> fun opt -> case opt of { Some -> f opt | None -> opt }
//│ simpler: ('a -> 'b) -> ((some & 'a) | ((none & 'c) & ~some)) -> 'b | 'c

simpler (fun x -> x.value)
//│ res: ((some & {value: 'a}) | ((none & 'b) & ~some)) -> 'a | 'b

:e
res 1
//│ ╔══[ERROR] Type mismatch in application:
//│ ║  l.155: 	res 1
//│ ║         	^^^^^
//│ ╟── expression of type `1` does not match type `(some & ?a & {value: ?b}) | ((none & ?c) & ~some)`
//│ ║  l.155: 	res 1
//│ ║         	    ^
//│ ╟── Note: constraint arises from reference:
//│ ║  l.148: 	def simpler = fun f -> fun opt -> case opt of { Some -> f opt | None -> opt }
//│ ╙──       	                                       ^^^
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: Program reached and unexpected state.
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.utils.package$.die(package.scala:134)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:182)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:107)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:156)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)


def funny = fun f -> case f of { Some -> f f }
//│ funny: 'a & some & ('a -> 'b) -> 'b

