
def rcd = { x = 1 }
//│ rcd: {x: 1}

rcd.x
//│ res: 1

rcd with { y = 2 }
//│ res: {x: 1}\y & {y: 2}

add res.x res.y
//│ res: int

rcd with { x = "oops" }
//│ res: {x: 1}\x & {x: "oops"}

res.x
//│ res: "oops"


def rcd = { }
//│ rcd: anything

id rcd with { x = "oops" }
//│ res: anything\x & {x: "oops"}

:d
res.x
//│ 0. Typing term res.x
//│  0. Typing term res
//│  0. : [(α10\x & {x: "oops"<string>})]
//│  CONSTRAIN [[(α10\x & {x: "oops"<string>})]] <! {x: α0}
//│    where α10 :> [[⊤]]
//│  C [[(α10\x & {x: "oops"<string>})]] <! {x: α0}
//│   C [(α10\x & {x: "oops"<string>})] <! {x: α0}
//│    C (α10\x & {x: "oops"<string>}) <! {x: α0}
//│     A  LhsTop  %  List(α10\x, {x: "oops"<string>})  <!  List({x: α0})  %  RhsBot
//│      A  LhsTop  %  List(α10\x, {x: "oops"<string>})  <!  List()  %  RhsField(x,α0)
//│       !List(~({x: "oops"<string>}), ⊥)
//│       !Some((~({x: "oops"<string>}) | {x: α0}))
//│       C α10 <! (~({x: "oops"<string>})\x | {x: α0}\x)
//│        C [[⊤]] <! (~({x: "oops"<string>})\x | {x: α0}\x)
//│         C [⊤] <! (~({x: "oops"<string>})\x | {x: α0}\x)
//│          C ⊤ <! (~({x: "oops"<string>})\x | {x: α0}\x)
//│           A  LhsTop  %  List(⊤)  <!  List(~({x: "oops"<string>})\x, {x: α0}\x)  %  RhsBot
//│            A  LhsTop  %  List()  <!  List(~({x: "oops"<string>})\x, {x: α0}\x)  %  RhsBot
//│ /!!!\ Uncaught error: java.lang.Exception: Internal Error: ~({x: α0}\x)\x (class mlscript.TyperDatatypes$Without)
//│ 	at: mlscript.utils.package$.lastWords(package.scala:135)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout(TyperHelpers.scala:114)
//│ 	at: mlscript.TyperHelpers$SimpleTypeImpl.pushPosWithout$(TyperHelpers.scala:105)
//│ 	at: mlscript.TyperDatatypes$SimpleType.pushPosWithout(TyperDatatypes.scala:34)
//│ 	at: mlscript.ConstraintSolver.rec$1(ConstraintSolver.scala:235)
//│ 	at: mlscript.ConstraintSolver.$anonfun$constrain$4(ConstraintSolver.scala:191)
//│ 	at: scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
//│ 	at: mlscript.TyperHelpers.trace(TyperHelpers.scala:17)
//│ 	at: mlscript.ConstraintSolver.annoyingImpl$1(ConstraintSolver.scala:107)
//│ 	at: mlscript.ConstraintSolver.annoying$1(ConstraintSolver.scala:105)


def f r = r with { x = "oops" }
//│ f: 'a -> 'a\x & {x: "oops"}

f rcd
//│ res: anything\x & {x: "oops"}

f (rcd with { y = 2 })
//│ res: (anything & {y: 2})\x & {x: "oops"}


def f a b = if true then a else b
//│ f: 'a -> 'a -> 'a

def f a b = (if true then a else b) with { x = "oops" }
//│ f: 'a -> 'a -> 'a\x & {x: "oops"}

def f a b = let tmp = a.x in (if true then a else b) with { x = "oops" }
//│ f: 'a & {x: anything} -> 'a -> 'a\x & {x: "oops"}


({ name = "Bob" } with { age = 123 }).age
//│ res: 123

({ name = "Bob" } with { age = 123 }).name
//│ res: "Bob"

({ name = "Bob" } with { name = 123 }).name
//│ res: 123

